#!/bin/sh

# Inject signed default EFI secure boot variables into the final image.
# There doesn't seem to be a nice mkosi hook to automate this.

set -e

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <input img>"
    exit 1
fi

if [ ! -d certs/ ]; then
    echo "Directory './certs/' doesn't exist, exiting"
    exit 1
fi

if [ "$(id -u)" -ne 0 ]; then
     echo "This script must be run as root"
     exit 1
fi

mkdir -p certs/mnt/
LOOP=$(losetup --show -f -P "$1")
mount "${LOOP}p1" certs/mnt/

# Push the new enrollment keys.
rm certs/mnt/loader/keys/auto/*
cp certs/efi/*.auth certs/mnt/loader/keys/auto/

# Push the keys as DER.
rm certs/mnt/mkosi.der || true
mkdir -p certs/mnt/keys/
cp certs/efi/*.der certs/mnt/keys/ || true

umount certs/mnt/
losetup -d "${LOOP}"
